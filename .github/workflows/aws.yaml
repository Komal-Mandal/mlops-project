deploy:
  needs: build
  runs-on: self-hosted

  steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2

    - name: Stop & remove old container (safe)
      run: |
        docker rm -f vehicleproj || true
        docker ps -aq | xargs -r docker rm -f

    - name: Free port 5000 (safe)
      run: |
        sudo fuser -k 5000/tcp || true

    - name: Pull image
      run: |
        docker pull ${{ secrets.ECR_URL }}:latest

    - name: Run container (safe)
      run: |
        docker run -d \
          --restart unless-stopped \
          --name vehicleproj \
          -p 5000:5000 \
          -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
          -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
          -e AWS_DEFAULT_REGION=${{ secrets.AWS_DEFAULT_REGION }} \
          ${{ secrets.ECR_URL }}:latest
